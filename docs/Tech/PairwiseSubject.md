# 结对 sub 声明

***目前 Alpha ID 尚未实现结对 sub 声明，我们将在后续路线图中实施此特性。***

## 概述

结对sub声明是指在一个信任体系下，对任一特定用户，访问任一依赖方业务系统时，签发用户与依赖方系统结对关联的sub声明，在依赖方系统内部能够唯一地标识用户。

同一个用户在不同的依赖方系统中发行的sub声明不同，且不可反算追踪，以避免依赖方系统在整个信用体系下采集用户信息或追踪用户活动轨迹。结对sub声明能有效限制信息采集扩大化，保护用户隐私并提高跟踪难度。

### 问题背景

我们通常使用一个固定且唯一的值来唯一标识一个用户，例如创建用户时随机产生的UUID。后续有关此用户的任何关联活动，均使用这个值来识别一个用户。

在一个内部自治的互信系统里，这么做没有什么问题，极大方便了在一系列事务中追踪用户。但是在一个独立或对立系统里，这个固定唯一值会造成安全隐患。某些系统可能会利用这个固定唯一值，在该信任体系的其他依赖方系统里采集信息和追踪用户，造成隐私泄露或行为轨迹泄露。

## 结对值的生成

结对值的生成应确保下列性质：

* IdP 能够通过用户Id和依赖方标识轻易计算
* 依赖方不能反算出用户Id
* 相同的用户在相同的依赖方内所计算的结对值均等价

基于上述性质，结对值的生成应采用下列函数：

### 结对值生成时机

业务运行中，用户和依赖方系统都是动态变化的，限于计算能力和性能限制，意味着结对值不可能预先生成。结对值生成总是发生在签发令牌时。

一旦生成结对值，IdP应当将其持久化保存，这是因为只有这样，才能在依赖方系统间执行声明转换时获得足够的信息。

## 依赖方系统间声明转换

与用户关联的事务在不同的依赖方系统传递时，仍需要追踪用户，但它将受到约束：

* IdP必须参与，因为只有IdP才知道全部知识。
* IdP可以充分保障用户的同意权，如果用户不同意，转换可能失败。

## 结对sub声明的审计分析

由于结对值的生成时机总是在签发令牌时，因此它也提供了一种对于用户访问依赖方系统的跟踪审计能力。如果一个用户始终没有访问过某个依赖方系统，那么他就不会具有特定于此依赖方系统的结对值。

