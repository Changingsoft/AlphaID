# 数据库升级脚本编制说明

&emsp;&emsp;研发过程中，对数据库实体及关系定义进行更改，需要固化为脚本并纳入源代码管理。执行发布上线时，顺次应用更改，确保数据结构的一致性。

## 编写脚本

1. 使用工具、或手动编写脚本。
2. 每一次更改都形成一个脚本，记下编写完成脚本的时间，按yyyyMMddHHmm.sql样式按顺序命名SQL脚本文件。
3. 在研发或测试数据库环境测试脚本，若执行符合预期，则固化该脚本，不得再进行编辑。
4. 若实体属性关系定义存在缺陷和疏漏，应编写新的更改脚本，并按上述规则应用到研发或测试环境。不得在已固化的脚本上直接修改。（**只新增不修改原则**） 

## 发布并应用脚本更改

&emsp;&emsp;发布到生产环境前，使用`Combine.bat`批处理程序拼合脚本，它将按时间顺序将脚本拼合并输出为一个`Combine.sql`文件。

&emsp;&emsp;在发布流程的适当时机，向生产环境应用Combined.sql脚本。

&emsp;&emsp;“只运行一次”脚本在发布流程结束时，从源代码中删除。

&emsp;&emsp;发布分支所做的更改合并到main和develop，打标签，完成发布。

## 严重注意事项

&emsp;&emsp;为避免因脚本缺陷导致研发、测试和生产环境数据库定义不一致，应用脚本必须**完全成功**。

&emsp;&emsp;为避免因脚本缺陷导致数据库误操作，研发、测试和生产数据库**必须具备日志级别的备份能力**，并可以在发生故障时，回退到故障前**指定的时点**。